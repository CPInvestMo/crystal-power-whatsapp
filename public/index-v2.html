<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Intelligence - Supply-Demand Matching System</title>
    
    <!-- CDN Imports -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Privacy Compliance Module -->
    <script src="js/privacy-compliance.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .glass-effect { 
            backdrop-filter: blur(10px); 
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .slide-up { 
            animation: slideUp 0.3s ease-out; 
        }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .pulse-dot { 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        .tab-active {
            background-color: #3B82F6;
            color: white;
        }
        .tab-inactive {
            background-color: #F3F4F6;
            color: #6B7280;
        }
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1);
        }
        .tooltip {
            position: relative;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1F2937;
            color: white;
            text-center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .match-score-high { color: #10B981; }
        .match-score-medium { color: #F59E0B; }
        .match-score-low { color: #EF4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <nav class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i class="fas fa-gem text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold">Crystal Intelligence</h1>
                    <span class="ml-3 px-3 py-1 bg-white/20 rounded-full text-sm">Supply-Demand Matching</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center">
                        <div class="w-3 h-3 bg-green-500 rounded-full pulse-dot mr-2"></div>
                        <span class="text-sm">System Active</span>
                    </div>
                    <div class="tooltip">
                        <a href="test-api.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plug mr-2"></i>API Testing
                        </a>
                        <span class="tooltiptext">Test WhatsApp Business API integration</span>
                    </div>
                    <div class="tooltip">
                        <a href="privacy-policy.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-shield-alt mr-2"></i>Privacy
                        </a>
                        <span class="tooltiptext">Egypt PDPL compliant privacy policy and data rights</span>
                    </div>
                    <div class="tooltip">
                        <button class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-info-circle mr-2"></i>Help
                        </button>
                        <span class="tooltiptext">System matches property supply with customer demand automatically</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6 mb-8 slide-up">
            <h2 class="text-2xl font-bold mb-2">Welcome to Crystal Intelligence</h2>
            <p class="text-blue-100">Intelligent supply-demand matching system for real estate. Connect properties with the right customers through AI-powered analysis.</p>
            <div class="mt-4 flex items-center text-sm text-blue-100">
                <i class="fas fa-shield-alt mr-2"></i>
                <span>No automated responses • Human agent recommendations • Smart matching</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-6">
            <nav class="flex space-x-2 bg-white rounded-lg p-1 shadow-sm">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all">
                    <i class="fas fa-tachometer-alt mr-2"></i>Matching Dashboard
                </button>
                <button onclick="switchTab('supply')" id="tab-supply" class="tab-inactive flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all">
                    <i class="fas fa-home mr-2"></i>Property Inventory
                </button>
                <button onclick="switchTab('demand')" id="tab-demand" class="tab-inactive flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all">
                    <i class="fas fa-users mr-2"></i>Customer Requirements
                </button>
            </nav>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-content">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Properties</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-total-properties">5</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-home text-blue-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Available</p>
                            <p class="text-2xl font-bold text-green-600" id="stat-available-properties">5</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Customer Demands</p>
                            <p class="text-2xl font-bold text-amber-600" id="stat-total-requirements">4</p>
                        </div>
                        <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users text-amber-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Active Matches</p>
                            <p class="text-2xl font-bold text-purple-600" id="stat-active-matches">7</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-handshake text-purple-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Success Rate</p>
                            <p class="text-2xl font-bold text-indigo-600" id="stat-success-rate">87.5%</p>
                        </div>
                        <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-indigo-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Urgent Actions</p>
                            <p class="text-2xl font-bold text-red-600" id="stat-urgent-actions">2</p>
                        </div>
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Supply vs Demand</h3>
                    <div style="height: 300px;">
                        <canvas id="supply-demand-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Matching Success Rate</h3>
                    <div style="height: 300px;">
                        <canvas id="matching-rate-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Lead Quality Distribution</h3>
                    <div style="height: 300px;">
                        <canvas id="lead-quality-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Action Recommendations and Recent Matches -->
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Priority Action Recommendations</h3>
                        <div class="tooltip">
                            <i class="fas fa-info-circle text-gray-400"></i>
                            <span class="tooltiptext">AI-generated recommendations based on matching scores and lead quality</span>
                        </div>
                    </div>
                    <div id="action-recommendations" class="space-y-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Recent High-Score Matches</h3>
                        <button onclick="refreshMatches()" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-sync mr-1"></i>Refresh
                        </button>
                    </div>
                    <div id="recent-matches" class="space-y-3">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Supply Management View -->
        <div id="view-supply" class="view-content hidden">
            <div class="mb-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Property Inventory Management</h2>
                <button onclick="showAddPropertyModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Property
                </button>
            </div>
            
            <div id="property-inventory" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Demand Tracking View -->
        <div id="view-demand" class="view-content hidden">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Customer Requirements Tracking</h2>
                <p class="text-gray-600 mt-2">Monitor and analyze customer demands for intelligent matching</p>
            </div>
            
            <div id="customer-requirements" class="space-y-4">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Property Modal -->
    <div id="add-property-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Add New Property</h3>
            <form id="property-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Property Title</label>
                        <input type="text" id="property-title" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Property Type</label>
                        <select id="property-type" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="apartment">Apartment</option>
                            <option value="villa">Villa</option>
                            <option value="studio">Studio</option>
                            <option value="penthouse">Penthouse</option>
                            <option value="office">Office</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <input type="text" id="property-location" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price (EGP)</label>
                        <input type="number" id="property-price" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Size (sqm)</label>
                        <input type="number" id="property-size" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bedrooms</label>
                        <input type="number" id="property-bedrooms" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bathrooms</label>
                        <input type="number" id="property-bathrooms" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddPropertyModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Add Property
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Sample Data
        const sampleProperties = [
            {
                id: 1,
                title: "Luxury Apartment in New Capital",
                type: "apartment",
                location: "New Administrative Capital",
                price: 2500000,
                size: 120,
                bedrooms: 3,
                bathrooms: 2,
                amenities: ["parking", "gym", "pool", "security"],
                status: "available",
                agent: "Ahmed Hassan"
            },
            {
                id: 2,
                title: "Villa in Sheikh Zayed",
                type: "villa",
                location: "Sheikh Zayed City",
                price: 4500000,
                size: 250,
                bedrooms: 4,
                bathrooms: 3,
                amenities: ["garden", "parking", "security", "maid_room"],
                status: "available",
                agent: "Fatma Mohamed"
            },
            {
                id: 3,
                title: "Studio in Zamalek",
                type: "studio",
                location: "Zamalek",
                price: 1200000,
                size: 45,
                bedrooms: 1,
                bathrooms: 1,
                amenities: ["river_view", "parking", "security"],
                status: "available",
                agent: "Omar Ali"
            },
            {
                id: 4,
                title: "Penthouse in Maadi",
                type: "penthouse",
                location: "Maadi",
                price: 6000000,
                size: 300,
                bedrooms: 5,
                bathrooms: 4,
                amenities: ["terrace", "parking", "gym", "pool", "security", "elevator"],
                status: "available",
                agent: "Sarah Ibrahim"
            },
            {
                id: 5,
                title: "Commercial Office in Downtown",
                type: "office",
                location: "Downtown Cairo",
                price: 3000000,
                size: 80,
                amenities: ["elevator", "security", "parking", "central_ac"],
                status: "available",
                agent: "Mohamed Saeed"
            }
        ];

        const sampleRequirements = [
            {
                id: 1,
                customerName: "Ahmed Hassan",
                customerId: "+201234567890",
                budgetMin: 2000000,
                budgetMax: 3000000,
                location: "New Administrative Capital",
                propertyType: "apartment",
                bedrooms: 3,
                urgency: "high",
                leadQuality: "high",
                sentiment: "positive",
                lastContact: "2024-01-15"
            },
            {
                id: 2,
                customerName: "Fatma Mohamed",
                customerId: "+201987654321",
                budgetMin: 4000000,
                budgetMax: 5000000,
                location: "Sheikh Zayed",
                propertyType: "villa",
                bedrooms: 4,
                urgency: "medium",
                leadQuality: "high",
                sentiment: "positive",
                lastContact: "2024-01-14"
            },
            {
                id: 3,
                customerName: "Omar Ali",
                customerId: "+201555444333",
                budgetMin: 1000000,
                budgetMax: 1500000,
                location: "Zamalek",
                propertyType: "studio",
                bedrooms: 1,
                urgency: "low",
                leadQuality: "medium",
                sentiment: "neutral",
                lastContact: "2024-01-13"
            },
            {
                id: 4,
                customerName: "Sarah Ibrahim",
                customerId: "+201777888999",
                budgetMin: 5500000,
                budgetMax: 7000000,
                location: "Maadi",
                propertyType: "penthouse",
                bedrooms: 4,
                urgency: "high",
                leadQuality: "high",
                sentiment: "positive",
                lastContact: "2024-01-15"
            }
        ];

        // Matching Algorithm
        function calculateMatchingScore(property, requirement) {
            let score = 0;
            let factors = [];

            // Location matching (35% weight)
            if (property.location.toLowerCase().includes(requirement.location.toLowerCase()) || 
                requirement.location.toLowerCase().includes(property.location.toLowerCase())) {
                score += 0.35;
                factors.push("Location match");
            }

            // Budget matching (25% weight)
            if (property.price >= requirement.budgetMin && property.price <= requirement.budgetMax) {
                score += 0.25;
                factors.push("Budget compatible");
            } else if (property.price <= requirement.budgetMax * 1.1) {
                score += 0.15; // Slightly over budget
                factors.push("Near budget range");
            }

            // Property type matching (20% weight)
            if (property.type === requirement.propertyType) {
                score += 0.20;
                factors.push("Property type match");
            }

            // Bedroom matching (15% weight)
            if (property.bedrooms === requirement.bedrooms) {
                score += 0.15;
                factors.push("Bedroom count match");
            } else if (Math.abs(property.bedrooms - requirement.bedrooms) === 1) {
                score += 0.10;
                factors.push("Similar bedroom count");
            }

            // Bonus for high-quality leads (5% weight)
            if (requirement.leadQuality === "high") {
                score += 0.05;
                factors.push("High-quality lead");
            }

            return { score: Math.round(score * 100), factors };
        }

        // Generate matches
        function generateMatches() {
            const matches = [];
            sampleRequirements.forEach(req => {
                sampleProperties.forEach(prop => {
                    const match = calculateMatchingScore(prop, req);
                    if (match.score >= 60) { // Only include matches above 60%
                        matches.push({
                            propertyId: prop.id,
                            requirementId: req.id,
                            property: prop,
                            requirement: req,
                            score: match.score,
                            factors: match.factors,
                            priority: match.score >= 85 ? "high" : match.score >= 70 ? "medium" : "low"
                        });
                    }
                });
            });
            return matches.sort((a, b) => b.score - a.score);
        }

        // Initialize Charts
        let charts = {};

        function initializeCharts() {
            // Supply vs Demand Chart
            const supplyDemandCtx = document.getElementById('supply-demand-chart');
            charts.supplyDemand = new Chart(supplyDemandCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Available Properties', 'Active Requirements', 'Successful Matches', 'Pending Matches'],
                    datasets: [{
                        data: [5, 4, 3, 4],
                        backgroundColor: ['#10B981', '#F59E0B', '#3B82F6', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Matching Rate Chart
            const matchingRateCtx = document.getElementById('matching-rate-chart');
            charts.matchingRate = new Chart(matchingRateCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Matching Success Rate (%)',
                        data: [75, 82, 88, 85, 92, 87, 89],
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Lead Quality Chart
            const leadQualityCtx = document.getElementById('lead-quality-chart');
            charts.leadQuality = new Chart(leadQualityCtx, {
                type: 'bar',
                data: {
                    labels: ['High Quality', 'Medium Quality', 'Low Quality'],
                    datasets: [{
                        label: 'Number of Leads',
                        data: [3, 1, 0],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.className = "tab-inactive flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all";
            });
            document.getElementById(`tab-${tabName}`).className = "tab-active flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all";

            // Update views
            document.querySelectorAll('[id^="view-"]').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`view-${tabName}`).classList.remove('hidden');

            // Load appropriate content
            if (tabName === 'supply') {
                loadPropertyInventory();
            } else if (tabName === 'demand') {
                loadCustomerRequirements();
            } else if (tabName === 'dashboard') {
                loadDashboardContent();
            }
        }

        // Load Dashboard Content
        function loadDashboardContent() {
            const matches = generateMatches();
            
            // Update action recommendations
            const actionRecommendations = document.getElementById('action-recommendations');
            const highPriorityMatches = matches.filter(m => m.priority === 'high').slice(0, 3);
            
            actionRecommendations.innerHTML = highPriorityMatches.map(match => `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 mr-2">HIGH PRIORITY</span>
                                <span class="text-xs text-gray-500">${match.requirement.customerName}</span>
                            </div>
                            <p class="text-sm text-gray-900 font-medium">Excellent match found: ${match.property.title}</p>
                            <p class="text-xs text-gray-600 mt-1">Match score: ${match.score}% - ${match.factors.slice(0, 2).join(', ')}</p>
                        </div>
                        <button onclick="contactCustomer('${match.requirement.customerId}')" class="ml-4 bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                            Contact Now
                        </button>
                    </div>
                </div>
            `).join('');

            // Update recent matches
            const recentMatches = document.getElementById('recent-matches');
            recentMatches.innerHTML = matches.slice(0, 5).map(match => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-900">${match.requirement.customerName}</span>
                            <span class="mx-2 text-gray-400">→</span>
                            <span class="text-sm text-gray-700">${match.property.title}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">${match.factors.slice(0, 2).join(', ')}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-bold match-score-${match.priority}">${match.score}%</span>
                        <p class="text-xs text-gray-500">match</p>
                    </div>
                </div>
            `).join('');
        }

        // Load Property Inventory
        function loadPropertyInventory() {
            const container = document.getElementById('property-inventory');
            container.innerHTML = sampleProperties.map(property => `
                <div class="bg-white rounded-xl shadow-sm p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-gray-900">${property.title}</h4>
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">${property.status}</span>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <p><i class="fas fa-map-marker-alt w-4"></i> ${property.location}</p>
                        <p><i class="fas fa-home w-4"></i> ${property.type.charAt(0).toUpperCase() + property.type.slice(1)}</p>
                        <p><i class="fas fa-expand-arrows-alt w-4"></i> ${property.size} sqm</p>
                        <p><i class="fas fa-money-bill-wave w-4"></i> ${property.price.toLocaleString()} EGP</p>
                        ${property.bedrooms ? `<p><i class="fas fa-bed w-4"></i> ${property.bedrooms} bedrooms</p>` : ''}
                        <p><i class="fas fa-user w-4"></i> Agent: ${property.agent}</p>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex flex-wrap gap-1">
                            ${property.amenities.slice(0, 3).map(amenity => `
                                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">${amenity}</span>
                            `).join('')}
                        </div>
                        <button onclick="viewPropertyMatches(${property.id})" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-search mr-1"></i>View Matches
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Load Customer Requirements
        function loadCustomerRequirements() {
            const container = document.getElementById('customer-requirements');
            container.innerHTML = sampleRequirements.map(req => {
                const matches = generateMatches().filter(m => m.requirementId === req.id);
                const bestMatch = matches.length > 0 ? matches[0] : null;
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-semibold text-gray-900">${req.customerName}</h4>
                                <p class="text-sm text-gray-600">${req.customerId}</p>
                                <div class="flex items-center mt-2 space-x-2">
                                    <span class="px-2 py-1 text-xs rounded-full bg-${req.leadQuality === 'high' ? 'green' : req.leadQuality === 'medium' ? 'yellow' : 'red'}-100 text-${req.leadQuality === 'high' ? 'green' : req.leadQuality === 'medium' ? 'yellow' : 'red'}-800">
                                        ${req.leadQuality.toUpperCase()} QUALITY
                                    </span>
                                    <span class="px-2 py-1 text-xs rounded-full bg-${req.urgency === 'high' ? 'red' : req.urgency === 'medium' ? 'amber' : 'gray'}-100 text-${req.urgency === 'high' ? 'red' : req.urgency === 'medium' ? 'amber' : 'gray'}-800">
                                        ${req.urgency.toUpperCase()} URGENCY
                                    </span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-600">${matches.length} matches found</p>
                                ${bestMatch ? `<p class="text-lg font-bold match-score-${bestMatch.priority}">${bestMatch.score}%</p>` : ''}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-4">
                            <div>
                                <p class="font-medium">Budget Range</p>
                                <p>${req.budgetMin.toLocaleString()} - ${req.budgetMax.toLocaleString()} EGP</p>
                            </div>
                            <div>
                                <p class="font-medium">Location</p>
                                <p>${req.location}</p>
                            </div>
                            <div>
                                <p class="font-medium">Property Type</p>
                                <p>${req.propertyType.charAt(0).toUpperCase() + req.propertyType.slice(1)}</p>
                            </div>
                            <div>
                                <p class="font-medium">Bedrooms</p>
                                <p>${req.bedrooms}</p>
                            </div>
                        </div>
                        
                        ${bestMatch ? `
                            <div class="bg-blue-50 rounded-lg p-3 mb-4">
                                <p class="text-sm font-medium text-blue-900">Best Match: ${bestMatch.property.title}</p>
                                <p class="text-xs text-blue-700">${bestMatch.factors.join(', ')}</p>
                            </div>
                        ` : ''}
                        
                        <div class="flex space-x-3">
                            <button onclick="viewCustomerMatches(${req.id})" class="flex-1 bg-blue-100 text-blue-700 px-3 py-2 rounded-lg text-sm hover:bg-blue-200">
                                View All Matches (${matches.length})
                            </button>
                            <button onclick="contactCustomer('${req.customerId}')" class="flex-1 bg-green-100 text-green-700 px-3 py-2 rounded-lg text-sm hover:bg-green-200">
                                Contact Customer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function showAddPropertyModal() {
            document.getElementById('add-property-modal').classList.remove('hidden');
            document.getElementById('add-property-modal').classList.add('flex');
        }

        function closeAddPropertyModal() {
            document.getElementById('add-property-modal').classList.add('hidden');
            document.getElementById('add-property-modal').classList.remove('flex');
        }

        // Event handlers
        function contactCustomer(customerId) {
            alert(`Opening WhatsApp to contact customer: ${customerId}\n\nThis would normally open WhatsApp Web or the mobile app.`);
        }

        function viewPropertyMatches(propertyId) {
            const property = sampleProperties.find(p => p.id === propertyId);
            const matches = generateMatches().filter(m => m.propertyId === propertyId);
            alert(`Property: ${property.title}\nFound ${matches.length} potential customer matches\n\nTop matches:\n${matches.slice(0, 3).map(m => `• ${m.requirement.customerName}: ${m.score}% match`).join('\n')}`);
        }

        function viewCustomerMatches(requirementId) {
            const requirement = sampleRequirements.find(r => r.id === requirementId);
            const matches = generateMatches().filter(m => m.requirementId === requirementId);
            alert(`Customer: ${requirement.customerName}\nFound ${matches.length} matching properties\n\nTop matches:\n${matches.slice(0, 3).map(m => `• ${m.property.title}: ${m.score}% match`).join('\n')}`);
        }

        function refreshMatches() {
            loadDashboardContent();
            alert('Matching results refreshed successfully!');
        }

        // Form submission
        document.getElementById('property-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newProperty = {
                id: sampleProperties.length + 1,
                title: document.getElementById('property-title').value,
                type: document.getElementById('property-type').value,
                location: document.getElementById('property-location').value,
                price: parseInt(document.getElementById('property-price').value),
                size: parseInt(document.getElementById('property-size').value),
                bedrooms: parseInt(document.getElementById('property-bedrooms').value) || 0,
                bathrooms: parseInt(document.getElementById('property-bathrooms').value) || 0,
                amenities: ['parking', 'security'],
                status: 'available',
                agent: 'New Agent'
            };
            
            sampleProperties.push(newProperty);
            closeAddPropertyModal();
            loadPropertyInventory();
            
            // Update statistics
            document.getElementById('stat-total-properties').textContent = sampleProperties.length;
            document.getElementById('stat-available-properties').textContent = sampleProperties.filter(p => p.status === 'available').length;
            
            alert('Property added successfully!');
        });

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            loadDashboardContent();
        });
    </script>
</body>
</html>